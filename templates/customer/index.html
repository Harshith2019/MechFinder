<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"></script>
    <title>MECHFINDER</title>

    <style>
      #latitude_id {
        display: none;
      }
      #longitude_id {
        display: none;
      }
      #name_AskHelpForm {
        display: none;
      }
      #email_AskHelpForm {
        display: none;
      }
      #contact_no_AskHelpForm {
        display: none;
      }
      #userName_AskHelpForm {
        display: none;
      }
      #cancel-btn {
        border-radius: 0;
      }
      #cancel_request_form {
        display: none;
      }
    </style>
  </head>
  <body>
    <form id="cancel_request_form" action="" method="post">
      {% csrf_token %}
      <label for="cancel_request"></label>
      <input type="text" name="cancel_request" id="cancel_request">
    </form>

    <div class="container">

      {{ map|safe }}

      <form style="display: {{ display_lat_lon_form }}" id="lat_lon_form" action="" method="post">
        {% csrf_token %}
        {{ form }}
        {{ ask_help_form.as_p }}
        <button class="btn btn-outline-success" onclick="getLocation()" name="button">Send Request</button>
      </form>
    </div>

    <br>
    <br>

    <div class="container">
      <button style="display: {{ display_cancel_btn }}" type="button" id="cancel-btn" class="btn btn-outline-danger" onClick="cancel_request()" name="cancel_btnn">Cancel Request</button>
    </div>

    <div class="container">
      <div id="customer_help"></div>
    </div>



    <script type="text/javascript">
      var socket = new WebSocket('ws://localhost:8000/ws/customer_help_url/');
      var data;
      socket.onmessage = function(event) {
        {% if map %}
        document.getElementById("cancel-btn").style.display = 'block';
        {% endif %}

        data = JSON.parse(event.data);
        console.log(data);

        var content = ""
        var i
        for (i = data.message.length-1; i >= 0; i--) {

          if(data.message[i].customer_name == "{{ userName }}") {

            content = content + '<div class="shadow-lg p-3 mb-5 bg-white rounded wow animate__fadeIn">' + '<h5>' + data.message[i].mechanic_name + " | " + data.message[i].email + '</h5>' + '<br>' + '<br>' + '+91 ' + data.message[i].contact_no  + "</div>"
            document.getElementById("cancel-btn").style.display = 'none';
            break;
          } else {
            document.getElementById("cancel-btn").style.display = 'block';
          }
        }

        document.querySelector('#customer_help').innerHTML = content;

      }
      socket.onclose = function(){
        console.log('closed!');
        //reconnect now
      }

      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
      }

      function showPosition(position) {
        document.getElementById('latitude_id').value = position.coords.latitude;
        document.getElementById('longitude_id').value = position.coords.longitude;
        document.getElementById('name_AskHelpForm').value = "{{ name }}";
        document.getElementById('userName_AskHelpForm').value = "{{ userName }}";
        document.getElementById('email_AskHelpForm').value = "{{ email }}";
        document.getElementById('contact_no_AskHelpForm').value = "{{ phone }}";

        document.getElementById("lat_lon_form").submit();

      }

      function cancel_request() {
        console.log('{{ userName }}');
        document.getElementById('cancel_request').value = 'YES';
        document.getElementById('cancel_request_form').submit()
      }

      var wow = new WOW(
        {
          boxClass:     'wow',      // animated element css class (default is wow)
          animateClass: 'animate__animated', // animation css class (default is animated)
          offset:       0,          // distance to the element when triggering the animation (default is 0)
          mobile:       true,       // trigger animations on mobile devices (default is true)
          live:         true,       // act on asynchronously loaded content (default is true)
          callback:     function(box) {
            // the callback is fired every time an animation is started
            // the argument that is passed in is the DOM node being animated
          },
          scrollContainer: null // optional scroll container selector, otherwise use window
        }
      );
      wow.init();


    </script>
  </body>
</html>
